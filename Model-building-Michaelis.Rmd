---
title: "Model building"
author: "Johanna Daas"
date: "3 12 2020"
output:  html_document
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(CoRC)
library(tidyverse)

unloadAllModels()
clearCustomKineticFunctions()
```

# Model building and setting Reaction Kinetics

This workflow shows how to build models in **CoRC**, as well as how to define your own reaction kinetics.

We will build a (very basic) epidemic model of with *S*usceptible, *I*nfectious and *R*ecovered (SIR) species.
Susceptibles can be infected and become infectious themselves, who can recover and not be infected anymore.

## Setup
First, we load the nessecary package. Make sure, that you have [**CoRC**](https://jpahle.github.io/CoRC/index.html) installed, before calling the library function.
```{r}
library(CoRC)
```

## Building the model
To start a model from scratch, you have to load a new Model. To create something *new*, you use the keyword "new".
```{r}
newModel()
```
Similarly, we can define species in the model like this:
```{r}
newSpecies("Susceptible")
```
Notice, how a default compartment is created. If you want to define your own compartment you can, and call it manually in the creation of the species or change the compartent of the species later. 
```{r}
newCompartment("Quarantine")

newSpecies("Infected", compartment = "Quarantine")
```
If you want to inspect elements of your model, you can use the "*get*" command. For example, you can look at your Species like this:
```{r}
getSpecies()
```
Now, our Susceptibles and our Infected are in different compartments. They will never meet and a plot of our infection would look like this:

```{r, include=FALSE}
# newSpecies("Recovered", compartment = "Quarantine")
# newReaction("Infected -> Recovered")
# setSpecies(key = getSpecies()$key, initial_concentration = c(100, 10, 0))
# 
# res <- runTC()$result %>% pivot_longer(-Time, names_to = "Species", values_to = "values")
# 
# ggplot(data = res) +
#   geom_line(aes(x = Time, y = values, color = Species))+
#   geom_line(aes(x = Time, y = 1000, color = "Susceptibles"))
```
This is a bit boring, and obviously not what we are to expect in a real situation. It is very hard to nearly impossible find and isolate all infected individuals. Therefore we need to change our model, to make it more realistic. First, we will look at a "no-quarantine"-situation.

We first need to set our Infected into our default compartment. For this we use the *set* family of functions. 
```{r}
setSpecies("Infected", compartment = "compartment")
getSpecies()
```

## Defining your own Reaction Kinetics
Of course, now our Susceptibles need to be able to be infected. For this, we need reactions that make species in our model interact with each other. In **CoRC** you can built your own reaction kinetics. 

We will try this on the Michaelis-Menten-Kinetics. The rate of a reaction with Michaelis-Menten-Kinetics is defined as:
$$v = \frac{v_{max} * S}{S + K_{m}}$$
where $v_{max}$ is the maximum reaction speed, $S$ is the concentration of the substrate and $K_{m}$ the Michaelis constant.

To define our kinetic function, we have to define a name, the function itself as well as the parameters:

```{r}
newKineticFunction(
  "manual MM",
  "((vmax * substrate) / (substrate + Km))",
  parameters = list(substrate = "substrate")
)
```
Now we want to add a reaction to our model, using our kinetic function.

```{r}
newReaction(
  "Susceptible + Infected -> 2 * Infected",
  fun = "manual MM",
  mapping = list(
    vmax = 0.1,
    Km = 0.1,
    substrate = "Infected"
  )
)

getReactions()
```
## More reactions:
Of course, **CoRC** has some typical reaction kinetics already implemented. This is also the case with the irriversible Michaelis-Menten. You can find all implemented functions [here](www.google.com) LINK!. 
Another helpful quality of **CoRC** is, that missing elements of a model get automatically created when needed.
```{r}
newReaction("Infected -> Recovered",
            fun = "Henri-Michaelis-Menten (irreversible)")
getReactions()
```
This not only creates the reaction but also creates species "Recovered".

Now we have to set the initial concentrations for our species, as well as some parameters and then we can run our model:
```{r}
setSpecies(key = getSpecies()$key, initial_concentration = c(1000, 10, 0))
getParameters()$key

setParameters(key = getParameters()$key, value = c(1, 0.01, 10, 0.01))

```
The parameters that we set specify that our rate at which our susceptibles are infected is bigger than our recovery rate.
Our model now looks like this:

```{r, echo = FALSE}
res <- runTC(duration = 1000, dt = 1)$result %>% pivot_longer(-Time, names_to = "Species", values_to = "Value")

ggplot(data = res)+
  geom_line(aes (x = Time, y = Value, color = Species))

```

Now, there are two things we can do about the spread of our "disease". 
First, we can try and put the infected into quarantine, but obviously not all infected will be in quarantine imidiatly.
We need a few new reactions:

```{r}
#Infected going into quarantine
newReaction("Infected{compartment} -> Infected {Quarantine}")
#infected in quarantine recovering
newReaction("Infected{Quarantine} -> Recovered")

```
We also have another way of halting the spread of disease: We can limit the time spent in close proximity to each other, in our model we can change the Michaelis-Constant to make contact between susceptibles and infected less likely:
```{r}
setParameters(key = "(Susceptible + Infected -> 2 * Infected).Km", value = 10)
```
And now it looks like this:
```{r, echo = FALSE}
res <- runTC(duration = 1000, dt = 1)$result %>% pivot_longer(-Time, names_to = "Species", values_to = "Value")

ggplot(data = res)+
  geom_line(aes (x = Time, y = Value, color = Species))

```

You can try and see for yourself how the reaction speed of infected going into quarantine, as well as the contact between susceptibles and infected changes our disease:
(A high Michaelis-constant means a low affinity.)

```{r, echo = FALSE}
fluidPage(
  sliderInput("Km",
    label = "Km: Susceptibles and Infected interacting",
    min = 0,
    max = 100,
    value = 50,
    step = 0.1),
  sliderInput("Vmax",
    label = "Vmax: Infected going into quarantine",
    min = 0,
    max = 10,
    value = 1,
    step = 0.01)
)

renderPlot({

  setParameters(key = "Infected).Km", value = input$"Km")
  setParameters(key = "Quarantine}).k1", value = input$Vmax)
  
  res <- runTC(duration = 1000, dt = 1)$result %>% pivot_longer(-Time, names_to = "Species", values_to = "Value")

  ggplot(data = res)+
    geom_line(aes (x = Time, y = Value, color = Species))
})

```