<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Johanna Daas, Jonas Förster" />


<title>Parameter Estimation</title>


<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>




<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>



<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="fluid-row" id="section-header">



<h1 class="title toc-ignore">Parameter Estimation</h1>
<h4 class="author">Johanna Daas, Jonas Förster</h4>

</div>


<div id="section-introduction" class="section level1">
<h1>Introduction</h1>
<p>In this workflow we will show you an implementation of a parameter estimation on the <a href="https://doi.org/10.1007/978-1-59745-525-1_2">Mendes 2009 paper</a><a href="#section-fn1" class="footnote-ref" id="section-fnref1"><sup>1</sup></a> on <strong>COPASI</strong> use cases.</p>
<p>You can see a <em>Timecourse</em> of the species of the model below. The points are measurements of two of the species in the model.</p>
<pre><code>## # A COPASI model reference:
## Model name: &quot;Kholodenko2000 - Ultrasensitivity and negative feedback bring oscillations in MAPK cascade&quot;
## Number of compartments: 1
## Number of species: 8
## Number of reactions: 10</code></pre>
<p><div class="row">
<div class="col-sm-2">
<div class="form-group shiny-input-container">
<label class="control-label" for="V1">(MAPKKK activation).V1</label>
<input class="js-range-slider" id="V1" data-min="0.25" data-max="4.75" data-from="2.5" data-step="0.1" data-grid="true" data-grid-num="9" data-grid-snap="false" data-prettify-separator="," data-prettify-enabled="true" data-keyboard="true" data-data-type="number"/>
</div>
<div class="form-group shiny-input-container">
<label class="control-label" for="V2">(MAPKKK inactivation).V2</label>
<input class="js-range-slider" id="V2" data-min="0.025" data-max="0.475" data-from="0.25" data-step="0.1" data-grid="true" data-grid-num="4.5" data-grid-snap="false" data-prettify-separator="," data-prettify-enabled="true" data-keyboard="true" data-data-type="number"/>
</div>
</div>
<div class="col-sm-2">
<div class="form-group shiny-input-container">
<label class="control-label" for="V5">(dephosphorylation of MAPKK-PP).V5</label>
<input class="js-range-slider" id="V5" data-min="0.075" data-max="1.425" data-from="0.75" data-step="0.1" data-grid="true" data-grid-num="6.75" data-grid-snap="false" data-prettify-separator="," data-prettify-enabled="true" data-keyboard="true" data-data-type="number"/>
</div>
<div class="form-group shiny-input-container">
<label class="control-label" for="V6">(dephosphorylation of MAPKK-P).V6</label>
<input class="js-range-slider" id="V6" data-min="0.075" data-max="1.425" data-from="0.75" data-step="0.1" data-grid="true" data-grid-num="6.75" data-grid-snap="false" data-prettify-separator="," data-prettify-enabled="true" data-keyboard="true" data-data-type="number"/>
</div>
</div>
<div class="col-sm-2">
<div class="form-group shiny-input-container">
<label class="control-label" for="V9">(dephosphorylation of MAPK-PP).V9</label>
<input class="js-range-slider" id="V9" data-min="0.05" data-max="0.95" data-from="0.5" data-step="0.1" data-grid="true" data-grid-num="9" data-grid-snap="false" data-prettify-separator="," data-prettify-enabled="true" data-keyboard="true" data-data-type="number"/>
</div>
<div class="form-group shiny-input-container">
<label class="control-label" for="V10">(dephosphorylation of MAPK-P).V10</label>
<input class="js-range-slider" id="V10" data-min="0.05" data-max="0.95" data-from="0.5" data-step="0.1" data-grid="true" data-grid-num="9" data-grid-snap="false" data-prettify-separator="," data-prettify-enabled="true" data-keyboard="true" data-data-type="number"/>
</div>
</div>
</div><div id="out0301e2929c739726" class="shiny-plot-output" style="width: 100% ; height: 400px"></div></p>
<p>As you can see, the model does not describe the data perfectly. You can try to get a better result and change the reaction speeds by using the slider.</p>
</div>
<div id="section-parameter-estimation" class="section level1">
<h1>Parameter estimation</h1>
<p>What you just did (or tried to do) was to find the parameters that make the model describe the data best. This is, what we call <em>Parameter Estimation</em>. As you could see, it was nearly impossible to find the combination of parameters that do that best. That is why we use algorithms that find the best fitting parameters.</p>
<p>Parameter estimation is an important topic when handling a model. In <strong>CoRC</strong> you have to</p>
<ol style="list-style-type: decimal">
<li>Built or load a model,</li>
<li>Define an experiment (with data to be fitted)</li>
<li>Define parameters that will be fitted</li>
<li>Run Parameter Estimation.</li>
</ol>
<p>We will go through these steps individually and explain what needs to be done as well as show visually how parameter estimation betters your fit.</p>
</div>
<div id="section-setup" class="section level1">
<h1>Setup:</h1>
<p>First, we have to load the required packages. Please make sure, you have <a href="https://jpahle.github.io/CoRC/index.html"><strong>CoRK</strong></a> as well as <a href="https://ggplot2.tidyverse.org/"><strong>ggplot2</strong></a> installed before calling the library function.</p>
<pre class="r"><code>library(CoRC)
library(ggplot2)</code></pre>
<div id="section-load-a-model" class="section level2">
<h2>1. Load a model</h2>
<p>As stated above, to make a parameter estimation, you have to have a model to work on. If you want to know how to build you own model, you can <a href="https://jpahle.github.io/CoRC/articles/model_building.html">klick here</a>.</p>
<p>In this workflow, we will instead load a SMBL-model.</p>
<pre class="r"><code>loadSBML(&quot;https://www.ebi.ac.uk/biomodels/model/download/BIOMD0000000010.2?filename=BIOMD0000000010_url.xml&quot;)</code></pre>
<pre><code>## # A COPASI model reference:
## Model name: &quot;Kholodenko2000 - Ultrasensitivity and negative feedback bring oscillations in MAPK cascade&quot;
## Number of compartments: 1
## Number of species: 8
## Number of reactions: 10</code></pre>
<p>We can inspect the species of the model like this:</p>
<pre class="r"><code>getSpecies()</code></pre>
<pre><code>## # A tibble: 8 x 13
##   key   name  compartment type  unit  initial_concent~ initial_number
##   &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;       &lt;chr&gt; &lt;chr&gt;            &lt;dbl&gt;          &lt;dbl&gt;
## 1 Mos{~ Mos   uVol        reac~ nmol~               90        5.42e16
## 2 Mos-~ Mos-P uVol        reac~ nmol~               10        6.02e15
## 3 Mek1~ Mek1  uVol        reac~ nmol~              280        1.69e17
## 4 Mek1~ Mek1~ uVol        reac~ nmol~               10        6.02e15
## 5 Mek1~ Mek1~ uVol        reac~ nmol~               10        6.02e15
## 6 Erk2~ Erk2  uVol        reac~ nmol~              280        1.69e17
## 7 Erk2~ Erk2~ uVol        reac~ nmol~               10        6.02e15
## 8 Erk2~ Erk2~ uVol        reac~ nmol~               10        6.02e15
## # ... with 6 more variables: concentration &lt;dbl&gt;, number &lt;dbl&gt;, rate &lt;dbl&gt;,
## #   number_rate &lt;dbl&gt;, initial_expression &lt;chr&gt;, expression &lt;chr&gt;</code></pre>
<p>This works in a similar way for reactions (<em>getReactions()</em>) and parameters (<em>getParameters()</em>)</p>
<p>If you have <strong>COPASI</strong> installed, you can also have a look at the model there:</p>
<pre class="r"><code># openCopasi()</code></pre>
</div>
<div id="section-define-an-experiment" class="section level2">
<h2>2. Define an Experiment</h2>
<p>Defining an experiment in <strong>CoRC</strong> means telling the program which data to fit and what the data actually describes.</p>
<p>So we first need data. It is always a good idea to take a look at your data before working with it. This way you can make sure nothing unexpected is happening.</p>
<pre class="r"><code>data &lt;- read.table(&quot;MAPKdata1.txt&quot;, header = TRUE)

data</code></pre>
<pre><code>##    Time Mos.P Erk2.P
## 1    50 65.70  13.20
## 2   100 98.30  20.50
## 3   150 91.90  43.10
## 4   200 88.50  66.40
## 5   300 80.40   2.03
## 6   400 49.20   0.60
## 7   500 37.80   2.03
## 8   600 24.80   1.45
## 9   800  8.56   4.79
## 10 1000  3.80  17.00</code></pre>
<p>Then you have to define the experiment for COPASI. You need the data, as well as the type and mappings for the species. You can choose a weight method for your data (which prevents parameters getting fitted more closely just because they have higher values).</p>
<p>Your data colums in your data file can be of type “time”, “dependent” and “independent”, and if you want to exclude a column you can choose “ignore”.</p>
<p>The mapping argument in the function maps the data columns with the species in your model. In our case, the provided data is time course data, and our values are “transient concentrations”. They are denoted like this: {[Species]}. You can find these notation by using the function <em>getSpeciesReferences()</em>.</p>
<p>Time needs to be mapped with NA.</p>
<p>Allowed weight methods are <em>‘mean’, ‘mean_square’, ‘sd’</em>, and <em>‘value_scaling’</em>.</p>
<pre class="r"><code>fit_experiments &lt;- defineExperiments(
  data = data,
  type = c(&quot;time&quot;, &quot;dependent&quot;, &quot;dependent&quot;),
  mapping = c(NA, &quot;{[Mos-P]}&quot;, &quot;{[Erk2-P]}&quot;),
  weight_method = &quot;mean_square&quot;
)</code></pre>
</div>
<div id="section-define-parameters" class="section level2">
<h2>3. Define Parameters</h2>
<p>We now have to define parameters that will be fitted.</p>
<p>First, let us take a look at all the parameters in the model:</p>
<pre class="r"><code>getParameters()</code></pre>
<pre><code>## # A tibble: 22 x 5
##    key                             name  reaction                  value mapping
##    &lt;chr&gt;                           &lt;chr&gt; &lt;chr&gt;                     &lt;dbl&gt; &lt;chr&gt;  
##  1 (MAPKKK activation).V1          V1    MAPKKK activation         2.5   &lt;NA&gt;   
##  2 (MAPKKK activation).Ki          Ki    MAPKKK activation         9     &lt;NA&gt;   
##  3 (MAPKKK activation).n           n     MAPKKK activation         1     &lt;NA&gt;   
##  4 (MAPKKK activation).K1          K1    MAPKKK activation        10     &lt;NA&gt;   
##  5 (MAPKKK inactivation).V2        V2    MAPKKK inactivation       0.25  &lt;NA&gt;   
##  6 (MAPKKK inactivation).KK2       KK2   MAPKKK inactivation       8     &lt;NA&gt;   
##  7 (phosphorylation of MAPKK).k3   k3    phosphorylation of MAPKK  0.025 &lt;NA&gt;   
##  8 (phosphorylation of MAPKK).KK3  KK3   phosphorylation of MAPKK 15     &lt;NA&gt;   
##  9 (phosphorylation of MAPKK-P).k4 k4    phosphorylation of MAPK~  0.025 &lt;NA&gt;   
## 10 (phosphorylation of MAPKK-P).K~ KK4   phosphorylation of MAPK~ 15     &lt;NA&gt;   
## # ... with 12 more rows</code></pre>
<p>Now, we only want to fit the reaction rates (parameters with V). To make our fit parameters we need to make a list of lists with the attributes of the different parameter-estimation settings. To <em>define</em> a parameter for Parameter Estimation, we use the defineParameterEstimationParameter()-Function.</p>
<pre class="r"><code>fit_parameters &lt;- list(
  defineParameterEstimationParameter(
    ref = &quot;{(MAPKKK activation).V1}&quot;,
    start_value = getParameters(&quot;(MAPKKK activation).V1&quot;)$value,
    lower_bound = getParameters(&quot;(MAPKKK activation).V1&quot;)$value * 0.1,
    upper_bound = getParameters(&quot;(MAPKKK activation).V1&quot;)$value * 1.9
    ),
  defineParameterEstimationParameter(
    ref = &quot;{(MAPKKK inactivation).V2}&quot;,
    start_value = getParameters(&quot;(MAPKKK inactivation).V2&quot;)$value,
    lower_bound = getParameters(&quot;(MAPKKK inactivation).V2&quot;)$value * 0.1,
    upper_bound = getParameters(&quot;(MAPKKK inactivation).V2&quot;)$value * 1.9
    ),
  defineParameterEstimationParameter(
    ref = &quot;{(dephosphorylation of MAPKK-PP).V5}&quot;,
    start_value = getParameters(&quot;(dephosphorylation of MAPKK-PP).V5&quot;)$value,
    lower_bound = getParameters(&quot;(dephosphorylation of MAPKK-PP).V5&quot;)$value * 0.1,
    upper_bound = getParameters(&quot;(dephosphorylation of MAPKK-PP).V5&quot;)$value * 1.9 
    ),
  defineParameterEstimationParameter(
    ref = &quot;{(dephosphorylation of MAPKK-P).V6}&quot;,
    start_value = getParameters(&quot;(dephosphorylation of MAPKK-P).V6&quot;)$value,
    lower_bound = getParameters(&quot;(dephosphorylation of MAPKK-P).V6&quot;)$value * 0.1,
    upper_bound = getParameters(&quot;(dephosphorylation of MAPKK-P).V6&quot;)$value * 1.9
    ),
  defineParameterEstimationParameter(
    ref = &quot;{(dephosphorylation of MAPK-PP).V9}&quot;,
    start_value = getParameters(&quot;(dephosphorylation of MAPK-PP).V9&quot;)$value,
    lower_bound = getParameters(&quot;(dephosphorylation of MAPK-PP).V9&quot;)$value * 0.1,
    upper_bound = getParameters(&quot;(dephosphorylation of MAPK-PP).V9&quot;)$value * 1.9
    ),
  defineParameterEstimationParameter(
    ref = &quot;{(dephosphorylation of MAPK-P).V10}&quot;,
    start_value = getParameters(&quot;(dephosphorylation of MAPK-P).V10&quot;)$value,
    lower_bound = getParameters(&quot;(dephosphorylation of MAPK-P).V10&quot;)$value * 0.1,
    upper_bound = getParameters(&quot;(dephosphorylation of MAPK-P).V10&quot;)$value * 1.9
  )
)</code></pre>
</div>
<div id="section-run-parameter-estimation" class="section level2">
<h2>4. Run parameter estimation</h2>
<p>To show how well our Parameter Estimation works, we want to print the model before and after parameter estimation. To do this, we have to <em>run</em> two Time Course Evaluations, one with the parameters now, and one with the parameters after the Parameter Estimation.</p>
<pre class="r"><code>before &lt;- runTimeCourse(duration = 1000, dt = 1)$result</code></pre>
<p>After doing this, we will now actually run the Parameter Estimation. We need the parameters, experiments with our data that will be fitted, and specify the method. We want to use the Levenberg Marquardt method but other methods are available as well. You can find them using the function <em>getValidReactionFunctions()</em> with your function as an argument.</p>
<p>Also, we specify that we want to update our model. This means, that all estimated parameters will be updated with the parameters of the best estimation. To compare the fit to the previous parameters we need to make sure we keep the previous fit. We already did that with our time course in the last chunk.</p>
<pre class="r"><code>result &lt;-
  runParameterEstimation(
    parameters  = fit_parameters,
    experiments = fit_experiments,
    method = list(
      method = &quot;LevenbergMarquardt&quot;,
      log_verbosity = 2
    ),
    update_model = TRUE
  )</code></pre>
<p>You can have a nicely readable version of the result by using the str() function. For space-reasons we will only take a look at the fitted values, but feel free to take a look at anything you find interesting.</p>
<pre class="r"><code>str(result$fitted_values)</code></pre>
<pre><code>## tibble [2 x 5] (S3: tbl_df/tbl/data.frame)
##  $ fitted_value            : chr [1:2] &quot;[Mos-P]&quot; &quot;[Erk2-P]&quot;
##  $ objective_value         : num [1:2] 30.2 13.7
##  $ root_mean_square        : num [1:2] 1.74 1.17
##  $ error_mean              : num [1:2] -0.441 0.114
##  $ error_mean_std_deviation: num [1:2] 1.68 1.16</code></pre>
</div>
<div id="section-visualize-results" class="section level2">
<h2>5. Visualize results</h2>
<p>Now we have estimated and updated the parameters of our current model. To compare our old model parameters to our new, we run another time course.</p>
<pre class="r"><code>after &lt;- runTimeCourse(duration = 1000, dt = 1)$result</code></pre>
<p>We will use ggplot for visualizing our results. If you have never worked with ggplot, this way to define a plot will look unusual to you.</p>
<p>We first want to plot our expermental data, as well as two time courses (before and after) for Erk2-P and Mos-P.</p>
<pre class="r"><code>Erk2P &lt;- 
  ggplot(mapping = aes(x = Time, y = `Erk2-P`)) +
  geom_point(data = data, aes(y = Erk2.P, color = &quot;experimental&quot;)) +
  geom_line (data = before, aes(color = &quot;before&quot;)) +
  geom_line (data = after, aes(color = &quot;after&quot;))

MosP &lt;-
  ggplot(mapping = aes(x = Time, y = `Mos-P`)) +
  geom_point(data = data, aes(y = Mos.P, color = &quot;experimental&quot;)) +
  geom_line (data = before, aes(color = &quot;before&quot;)) +
  geom_line (data = after, aes(color = &quot;after&quot;))</code></pre>
<p>At the end, our result for Erk2-P</p>
<pre class="r"><code>Erk2P</code></pre>
<p><img src="file2e3449502acc_files/figure-html/unnamed-chunk-17-1.png" width="672" /> as well as our result for Mos-P</p>
<pre class="r"><code>MosP</code></pre>
<p><img src="file2e3449502acc_files/figure-html/unnamed-chunk-18-1.png" width="672" /> show, how well the Parameter Estimation was able to fit our model to the data.</p>
<p>At the end, we can <em>unload</em> our model, to free some memory.</p>
<pre class="r"><code>unloadModel()</code></pre>
</div>
<div id="section-references" class="section level2">
<h2>References</h2>
</div>
</div>
<div class="footnotes">
<hr />
<ol>
<li id="section-fn1"><p>Mendes P., Hoops S., Sahle S., Gauges R., Dada J., Kummer U. (2009) Computational Modeling of Biochemical Networks Using COPASI. In: Maly I. (eds) Systems Biology. Methods in Molecular Biology (Methods and Protocols), vol 500. Humana Press. <a href="https://doi.org/10.1007/978-1-59745-525-1_2" class="uri">https://doi.org/10.1007/978-1-59745-525-1_2</a><a href="#section-fnref1" class="footnote-back">↩︎</a></p></li>
</ol>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("section-TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
